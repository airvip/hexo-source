---
title: Mysql中对外键的理解
date: 2018-04-07 10:13:00
tags: 
    - Mysql
---

> 只要世间有酒,我就喝不够!

虽然我们在真实的环境中不推荐使用外键，但是在数据库中有外键的概念。由于我想搞清楚外键到底是个什么东西，所以在这里简单描述下我们外键的理解。

<!-- more -->

外键的使用与否还是要看业务场景的，如果并发量大的业务最好不要使用数据库的一些高级特性。

# 表结构

这是我们想要的用户完整数据：

``` html
id      | 账户    | 密码    | 状态   |  性别    | 民族   | 身份证号码 |
-------------------------------------------------------------------
1000    | 张三    | 123     | 启用   | 男      | 汉     | 123456    |
-------------------------------------------------------------------
1001    | 李四    | 123     | 启用   | 男      | 汉     | 234567    |
-------------------------------------------------------------------
1002    | 王五    | 123     | 启用   | 男      | 汉     | 345678    |
```

但是为了我们方便把用户账户信息与基本信息分开，我们就拆分成两张表。

表1、主表 <用户表> 主键：id

``` mysql
id      | acc     | pass   | status |
-------------------------------------
1000    | 张三    | 123     | 启用   |
-------------------------------------
1001    | 李四    | 123     | 启用   |
-------------------------------------
1002    | 王五    | 123     | 启用   |
```

表2、子表 <用户信息表> 主键：id  外键：pid(即主表的id)

``` html
id    | pid    | sex     | nation | id_num   |
----------------------------------------------
1     | 1000   | 男      | 汉     | 123456    |
----------------------------------------------
2     | 1001   | 男      | 汉     | 234567    |
----------------------------------------------
3     | 1002   | 男      | 汉     | 345678    |
```

设计的时候，就给表2加入一个外键，这个外键就是关联表1中的 id 字段。这样表1就是主表，表2就是子表。

# 如何设置外键

``` mysql
# 创建用户表
CREATE TABLE IF NOT EXISTS `user`(
 `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
 `acc` varchar(20) NOT NULL DEFAULT '' COMMENT '账户',
 `pass` varchar(60) NOT NULL DEFAULT '' COMMENT '密码',
 `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态0待审核1显示-1禁用',
  PRIMARY KEY (`id`)
)ENGINE = InnoDB DEFAULT CHARSET=utf8mb4 COMMENT = '用户表';

# 创建用户信息表
CREATE TABLE IF NOT EXISTS `user_info`(
 `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
 `pid` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联用户表id',
 `sex` varchar(5) NOT NULL DEFAULT '' COMMENT '性别',
 `nation` varchar(20) NOT NULL DEFAULT '' COMMENT '民族',
 `id_num` varchar(20) NOT NULL DEFAULT '' COMMENT '身份证号',
  PRIMARY KEY (`id`),
  KEY `p_id` (`pid`),
  CONSTRAINT `p_id` FOREIGN KEY (`pid`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE = InnoDB DEFAULT CHARSET=utf8mb4 COMMENT = '用户信息表';
```

说明：把pid列 设为外键 ，参照user表的id列。 当user表中id值删除， user_info表中对应的行删除； 当user表的id值改变， user_info表中对应的行值改变。

建立外键的前提： 存在外键表的外键类型必须与主表字段类型一致。
指定外键关键字： foreign key(列名)
引用外键关键字： references <主表名>(主表主键)
事件触发限制: on delete 和 on update , 可设参数 cascade(跟随主表键值改动), restrict(限制主表中的外键改动),set Null(设空值）,set Default（设默认值）,[默认]no action

# 外键作用

保持数据一致性，完整性，主要用于控制存储在外键表中的数据。

如何保证数据的一致性、完整性？
通过事件触发器中设置的相关选项保证数据一致性与完整性。

CASCADE 为级联执行

* 主表删除行，连带从表的相关行一起删除；
* 主表修改主键值，连带从表相关行的外键值一起修改。两种方法提供给用户选择。无论选取哪种方法，从表里都不会有多余行。从另一个角度理解，用拒绝同一事物在从表中的标志与主表不一致来实现与主表中的标志一致。

RESTRICT 为阻止执行

* 从表插入新行，其外键值不是主表的主键值便阻止插入；
* 从表修改外键值，新值不是主表的主键值便阻止修改；
* 主表删除行，其主键值在从表里存在便阻止删除(要想删除，必须先删除从表的相关行)；
* 主表修改主键值，键值在从表里存在便阻止修改(要想修改，必须先删除从表的相关行)。

# 主键外键索引

主键、外键及索引的区别表

| 名称 | 定义 | 作用 | 个数 |
|----|----|----|----|
|主键|唯一标识一条记录，不能有重复的，不允许为空|用来保证数据完整性|只能1个|
|外键|表的外键是另一表的主键, 外键可以有重复的, 可以是空值|用来和其他表建立联系用的|可有多个|
|索引|该字段没有重复值，但可以有一个空值|提高查询排序的速度|可有多个唯一索引|